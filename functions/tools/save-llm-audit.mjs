
import { z } from 'zod';
import { DynamoDBClient, PutItemCommand } from '@aws-sdk/client-dynamodb';
import { marshall } from '@aws-sdk/util-dynamodb';
import { loadContent } from '../utils/content.mjs';

const ddb = new DynamoDBClient();

export const saveLlmAuditTool = {
  isMultiTenant: true,
  name: 'saveLlmAudit',
  description: 'Saves the audit results for LLM-likeness for content',
  schema: z.object({
    contentId: z.string().describe('Identifier of the content'),
    scores: z.object({
      overall: z.number().min(0).max(1).describe('How much the content reads as generated by an LLM'),
      style: z.number().min(0).max(1).describe('How much the overall style is consistent with LLM generated content'), specificity: z.number().min(0).max(1).describe('How much the content reads as overly specific'),
      repetition: z.number().min(0).max(1).describe('How much repetition of ideas and heading structure were present'), risk_hallucination: z.number().min(0).max(1).describe('The likelihood some of the content was made up and incorrect')
    }),
    rationale: z.string().min(1).max(500).describe('Brief summary of why the content received the scores'),
    redFlags: z.array(z.string().min(1)).max(20),
  }),
  handler: async (tenantId, { contentId, scores, rationale, redFlags }) => {
    try {
      let content;
      try {
        content = await loadContent(tenantId, contentId);
      } catch (e) {
        console.error(e);
        return { error: e.message };
      }

      await ddb.send(new PutItemCommand({
        TableName: process.env.TABLE_NAME,
        Item: marshall({
          pk: `${tenantId}#${contentId}`,
          sk: `audit#${content.version}#llm`,
          scores,
          rationale,
          redFlags,
          createdAt: Date.now()
        })
      }));

      return { message: `Audit saved for v${content.version} of the content` };
    } catch (err) {
      console.error(err);
      return { error: 'Something went wrong' };
    }
  }
};

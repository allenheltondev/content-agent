AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >
  Autonomous AI Agent that proofreads and helps with blog posts

Parameters:
  Origin:
    Type: String
    Default: "http://localhost:5173"
  SerpApiKey:
    Type: String
    NoEcho: true
    Default: ""
  MomentoApiKey:
    Type: String
    NoEcho: true
    Default: ""
    Description: "Momento API key for generating scoped tokens for real-time notifications"
  MomentoCacheName:
    Type: String
    Default: "docs"
    Description: "Momento cache name for review notifications"

Metadata:
  esbuild-properties: &esbuild-properties
    Format: esm
    Minify: true
    OutExtension:
      - .js=.mjs
    Target: es2020
    Sourcemap: false
    EntryPoints:
      - index.mjs
    Banner:
      - js=import { createRequire } from 'module'; const require = createRequire(import.meta.url);
    External:
      - "@aws-sdk/*"
    Loader: []

Globals:
  Function:
    Runtime: nodejs22.x
    CodeUri: functions
    Architectures:
      - arm64
    Tracing: Active
    Timeout: 25
    MemorySize: 1024
    Environment:
      Variables:
        AWS_NODEJS_CONNECTION_REUSE_ENABLED: 1
        ORIGIN: !Ref Origin
  Api:
    Cors:
      AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
      AllowHeaders: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
      AllowOrigin: !Sub "'${Origin}'"

Mappings:
  RegionToEndPoint:
    us-east-1:
      URL: https://api.cache.cell-us-east-1-1.prod.a.momentohq.com
    us-west-2:
      URL: https://api.cache.cell-4-us-west-2-1.prod.a.momentohq.com
    eu-west-1:
      URL: https://api.cache.cell-1-eu-west-1-1.prod.a.momentohq.com

Resources:
  ContentTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  ContentBucket:
    Type: AWS::S3::Bucket
    Properties:
      LifecycleConfiguration:
        Rules:
          - Id: DeleteRule
            Status: Enabled
            ExpirationInDays: 7
      VersioningConfiguration:
        Status: Enabled

  AgentMemoryParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /agents/memory
      Type: String
      Value: placeholder

  BlogUserPool:
    Type: AWS::Cognito::UserPool
    DeletionPolicy: Delete
    Properties:
      UserPoolName: !Sub "${AWS::StackName}-user-pool"
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true
      Schema:
        - Name: email
          AttributeDataType: String
          Required: true
          Mutable: true
        - Name: tenantId
          AttributeDataType: String
          Required: false
          Mutable: true
      LambdaConfig:
        PostConfirmation: !GetAtt PostConfirmationTrigger.Arn
        PreTokenGeneration: !GetAtt PreTokenGenerationTrigger.Arn
      UserPoolTags:
        Project: BlogAPI

  BlogUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref BlogUserPool
      ClientName: !Sub "${AWS::StackName}-client"
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
      TokenValidityUnits:
        AccessToken: hours
        IdToken: hours
        RefreshToken: days
      AccessTokenValidity: 1
      IdTokenValidity: 1
      RefreshTokenValidity: 30
      CallbackURLs:
        - !Ref Origin
        - "http://localhost:5173"
      LogoutURLs:
        - !Ref Origin
        - "http://localhost:5173"
      SupportedIdentityProviders:
        - COGNITO

  CreateAgentMemory:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt CreateAgentMemoryFunction.Arn
      Version: !Ref AWS::StackName

  CreateAgentMemoryFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - bootstrap/create-agent-memory.mjs
    Properties:
      Handler: bootstrap/create-agent-memory.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
                - ssm:PutParameter
                - ssm:DeleteParameter
              Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/agents/memory"
            - Effect: Allow
              Action:
                - bedrock-agentcore:CreateMemory
                - bedrock-agentcore:DeleteMemory
              Resource: "*"
      Environment:
        Variables:
          MEMORY_PARAMETER: !Ref AgentMemoryParameter

  PostConfirmationTrigger:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - auth/post-confirmation.mjs
    Properties:
      Handler: auth/post-confirmation.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - cognito-idp:AdminUpdateUserAttributes
              Resource: !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/*"

  PostConfirmationTriggerPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref PostConfirmationTrigger
      Action: lambda:InvokeFunction
      Principal: cognito-idp.amazonaws.com
      SourceArn: !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${BlogUserPool}"

  PreTokenGenerationTrigger:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - auth/pre-token-generation.mjs
    Properties:
      Handler: auth/pre-token-generation.handler
      Policies:
        - AWSLambdaBasicExecutionRole

  PreTokenGenerationTriggerPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref PreTokenGenerationTrigger
      Action: lambda:InvokeFunction
      Principal: cognito-idp.amazonaws.com
      SourceArn: !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${BlogUserPool}"

  BlogApiAuthorizer:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - auth/authorizer.mjs
    Properties:
      Handler: auth/authorizer.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - cognito-idp:GetUser
              Resource: "*"
      Environment:
        Variables:
          USER_POOL_ID: !Ref BlogUserPool
          USER_POOL_CLIENT_ID: !Ref BlogUserPoolClient

  LLMAuditAgent:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - agents/llm-auditor.mjs
    Properties:
      Handler: agents/llm-auditor.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/agents/memory"
            - Effect: Allow
              Action:
                - bedrock-agentcore:CreateEvent
                - bedrock-agentcore:ListEvents
              Resource: "*"
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
              Resource: !GetAtt ContentTable.Arn
            - Effect: Allow
              Action: bedrock:InvokeModel
              Resource:
                - !Sub arn:${AWS::Partition}:bedrock:${AWS::Region}::foundation-model/amazon.nova-pro-v1:0
      Environment:
        Variables:
          MEMORY_PARAMETER: !Ref AgentMemoryParameter
          TABLE_NAME: !Ref ContentTable

  BrandAuditAgent:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - agents/on-brand-auditor.mjs
    Properties:
      Handler: agents/on-brand-auditor.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/agents/memory"
            - Effect: Allow
              Action:
                - bedrock-agentcore:CreateEvent
                - bedrock-agentcore:ListEvents
              Resource: "*"
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
              Resource: !GetAtt ContentTable.Arn
            - Effect: Allow
              Action: bedrock:InvokeModel
              Resource:
                - !Sub arn:${AWS::Partition}:bedrock:${AWS::Region}::foundation-model/amazon.nova-lite-v1:0
            - Effect: Allow
              Action: bedrock-agentcore:RetrieveMemoryRecords
              Resource: "*"
      Environment:
        Variables:
          MEMORY_PARAMETER: !Ref AgentMemoryParameter
          TABLE_NAME: !Ref ContentTable

  ReadabilityAgent:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - agents/readability.mjs
    Properties:
      Handler: agents/readability.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/agents/memory"
            - Effect: Allow
              Action:
                - bedrock-agentcore:CreateEvent
                - bedrock-agentcore:ListEvents
              Resource: "*"
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
              Resource: !GetAtt ContentTable.Arn
            - Effect: Allow
              Action: bedrock:InvokeModel
              Resource:
                - !Sub arn:${AWS::Partition}:bedrock:${AWS::Region}::foundation-model/amazon.nova-lite-v1:0
      Environment:
        Variables:
          MEMORY_PARAMETER: !Ref AgentMemoryParameter
          TABLE_NAME: !Ref ContentTable

  FactCheckAgent:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - agents/fact-checker.mjs
    Properties:
      Handler: agents/fact-checker.handler
      Timeout: 60
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/agents/memory"
            - Effect: Allow
              Action:
                - bedrock-agentcore:CreateEvent
                - bedrock-agentcore:ListEvents
              Resource: "*"
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
              Resource: !GetAtt ContentTable.Arn
            - Effect: Allow
              Action: bedrock:InvokeModel
              Resource:
                - !Sub arn:${AWS::Partition}:bedrock:${AWS::Region}::foundation-model/amazon.nova-pro-v1:0
      Environment:
        Variables:
          MEMORY_PARAMETER: !Ref AgentMemoryParameter
          TABLE_NAME: !Ref ContentTable
          SERPAPI_KEY: !Ref SerpApiKey

  SummaryAgent:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - agents/summarizer.mjs
    Properties:
      Handler: agents/summarizer.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/agents/memory"
            - Effect: Allow
              Action:
                - bedrock-agentcore:CreateEvent
                - bedrock-agentcore:ListEvents
              Resource: "*"
            - Effect: Allow
              Action:
                - dynamodb:Query
                - dynamodb:PutItem
                - dynamodb:GetItem
              Resource: !GetAtt ContentTable.Arn
            - Effect: Allow
              Action: bedrock:InvokeModel
              Resource:
                - !Sub arn:${AWS::Partition}:bedrock:${AWS::Region}::foundation-model/amazon.nova-pro-v1:0
      Environment:
        Variables:
          MEMORY_PARAMETER: !Ref AgentMemoryParameter
          TABLE_NAME: !Ref ContentTable

  ListPostsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - api/list-posts.mjs
    Properties:
      Handler: api/list-posts.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:Query
              Resource:
                - !GetAtt ContentTable.Arn
                - !Sub "${ContentTable.Arn}/index/GSI1"
      Environment:
        Variables:
          TABLE_NAME: !Ref ContentTable
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref BlogApi
            Path: /posts
            Method: GET

  GetPostFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - api/get-post.mjs
    Properties:
      Handler: api/get-post.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
              Resource: !GetAtt ContentTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref ContentTable
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref BlogApi
            Path: /posts/{postId}
            Method: GET

  CreatePostFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - api/create-post.mjs
    Properties:
      Handler: api/create-post.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:PutItem
              Resource: !GetAtt ContentTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref ContentTable
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref BlogApi
            Path: /posts
            Method: POST

  UpdatePostFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - api/update-post.mjs
    Properties:
      Handler: api/update-post.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:UpdateItem
              Resource: !GetAtt ContentTable.Arn
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: !Sub arn:aws:events:${AWS::Region}:${AWS::AccountId}:event-bus/default
      Environment:
        Variables:
          TABLE_NAME: !Ref ContentTable
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref BlogApi
            Path: /posts/{postId}
            Method: PUT

  PostProcessingFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - api/post-processing.mjs
    Properties:
      Handler: api/post-processing.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:Query
                - dynamodb:UpdateItem
                - dynamodb:PutItem
              Resource: !GetAtt ContentTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref ContentTable
      Events:
        PostUpdated:
          Type: EventBridgeRule
          Properties:
            Pattern:
              source:
                - content-agent
              detail-type:
                - Post Updated

  DeletePostFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - api/delete-post.mjs
    Properties:
      Handler: api/delete-post.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:DeleteItem
              Resource: !GetAtt ContentTable.Arn
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: !Sub arn:aws:events:${AWS::Region}:${AWS::AccountId}:event-bus/default
      Environment:
        Variables:
          TABLE_NAME: !Ref ContentTable
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref BlogApi
            Path: /posts/{postId}
            Method: DELETE

  DeletePostAsyncFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - api/delete-post-async.mjs
    Properties:
      Handler: api/delete-post-async.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:Query
                - dynamodb:BatchWriteItem
                - dynamodb:DeleteItem
              Resource: !GetAtt ContentTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref ContentTable
      Events:
        EB:
          Type: EventBridgeRule
          Properties:
            Pattern:
              source:
                - content-agent
              detail-type:
                - Delete Post

  GetSuggestionsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - api/get-suggestions.mjs
    Properties:
      Handler: api/get-suggestions.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:Query
              Resource: !GetAtt ContentTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref ContentTable
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref BlogApi
            Path: /posts/{postId}/suggestions
            Method: GET

  StartReviewFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - api/start-review.mjs
    Properties:
      Handler: api/start-review.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
              Resource: !GetAtt ContentTable.Arn
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: !Sub arn:aws:events:${AWS::Region}:${AWS::AccountId}:event-bus/default
      Environment:
        Variables:
          TABLE_NAME: !Ref ContentTable
          MOMENTO_AUTH_TOKEN: !Ref MomentoApiKey
          MOMENTO_CACHE_NAME: !Ref MomentoCacheName
          SUBSCRIBE_BASE_URL:
            Fn::FindInMap:
              - RegionToEndPoint
              - !Ref AWS::Region
              - URL
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref BlogApi
            Path: /posts/{postId}/reviews
            Method: POST

  UpdateSuggestionStatusFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - api/update-suggestion-status.mjs
    Properties:
      Handler: api/update-suggestion-status.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:DeleteItem
                - dynamodb:UpdateItem
                - dynamodb:PutItem
              Resource: !GetAtt ContentTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref ContentTable
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref BlogApi
            Path: /posts/{postId}/suggestions/{suggestionId}/statuses
            Method: POST

  GetProfileFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - api/get-profile.mjs
    Properties:
      Handler: api/get-profile.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
              Resource: !GetAtt ContentTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref ContentTable
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref BlogApi
            Path: /profile
            Method: GET

  CreateProfileFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - api/create-profile.mjs
    Properties:
      Handler: api/create-profile.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:PutItem
              Resource: !GetAtt ContentTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref ContentTable
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref BlogApi
            Path: /profile
            Method: POST

  UpdateProfileFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - api/update-profile.mjs
    Properties:
      Handler: api/update-profile.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:UpdateItem
              Resource: !GetAtt ContentTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref ContentTable
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref BlogApi
            Path: /profile
            Method: PUT

  GetStatsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - api/get-stats.mjs
    Properties:
      Handler: api/get-stats.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:Query
              Resource:
                - !GetAtt ContentTable.Arn
                - !Sub "${ContentTable.Arn}/index/GSI1"
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/agents/memory"
            - Effect: Allow
              Action:
                - bedrock-agentcore:RetrieveMemoryRecords
              Resource: "*"
      Environment:
        Variables:
          TABLE_NAME: !Ref ContentTable
          MEMORY_PARAMETER: !Ref AgentMemoryParameter
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref BlogApi
            Path: /stats
            Method: GET

  BlogApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: api
      Auth:
        DefaultAuthorizer: LambdaAuthorizer
        AddDefaultAuthorizerToCorsPreflight: false
        Authorizers:
          LambdaAuthorizer:
            FunctionPayloadType: REQUEST
            FunctionArn: !GetAtt BlogApiAuthorizer.Arn
            Identity:
              Headers:
                - Authorization
      MethodSettings:
        - MetricsEnabled: True
          ResourcePath: "/*"
          HttpMethod: "*"
          LoggingLevel: ERROR
          DataTraceEnabled: True
      DefinitionBody:
        Fn::Transform:
          Name: AWS::Include
          Parameters:
            Location: ./openapi.yaml

  BlogApiAuthorizerInvokeRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: AuthorizerInvokePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: lambda:InvokeFunction
                Resource: !GetAtt BlogApiAuthorizer.Arn

  AnalyzeContentStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Type: STANDARD
      DefinitionUri: workflows/analyze-content.asl.json
      DefinitionSubstitutions:
        TableName: !Ref ContentTable
        FactCheckAgent: !GetAtt FactCheckAgent.Arn
        BrandAuditAgent: !GetAtt BrandAuditAgent.Arn
        LLMAuditAgent: !GetAtt LLMAuditAgent.Arn
        ReadabilityAgent: !GetAtt ReadabilityAgent.Arn
        SummarizeAgent: !GetAtt SummaryAgent.Arn
      Policies:
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: lambda:InvokeFunction
              Resource:
                - !GetAtt FactCheckAgent.Arn
                - !GetAtt BrandAuditAgent.Arn
                - !GetAtt LLMAuditAgent.Arn
                - !GetAtt ReadabilityAgent.Arn
                - !GetAtt SummaryAgent.Arn
            - Effect: Allow
              Action:
                - dynamodb:PutItem
                - dynamodb:UpdateItem
              Resource: !GetAtt ContentTable.Arn
            - Effect: Allow
              Action: events:PutEvents
              Resource: !Sub arn:${AWS::Partition}:events:${AWS::Region}:${AWS::AccountId}:event-bus/default
      Events:
        Analyze:
          Type: EventBridgeRule
          Properties:
            Pattern:
              source:
                - content-agent
              detail-type:
                - Start Content Analysis

  ApiConnection:
    Type: AWS::Events::Connection
    Properties:
      AuthorizationType: API_KEY
      AuthParameters:
        ApiKeyAuthParameters:
          ApiKeyName: Authorization
          ApiKeyValue: !Ref MomentoApiKey

  ApiDestinationsTargetRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sts:AssumeRole
      Path: /service-role/
      Policies:
        - PolicyName: destinationinvoke
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - events:InvokeApiDestination
                Resource:
                  - !GetAtt MomentoApiTopicsPost.Arn

  MomentoApiTopicsPost:
    Type: AWS::Events::ApiDestination
    Properties:
      ConnectionArn: !GetAtt ApiConnection.Arn
      HttpMethod: POST
      InvocationEndpoint:
        Fn::Sub:
          - ${RegionEndpoint}/topics/*/*
          - RegionEndpoint:
              Fn::FindInMap:
                - RegionToEndPoint
                - !Ref AWS::Region
                - URL
      InvocationRateLimitPerSecond: 300

  MomentoApiTopicsPostRule:
    Type: AWS::Events::Rule
    Properties:
      EventPattern:
        detail-type:
          - Content Analysis Completed
      State: ENABLED
      Targets:
        - Id: topicPublish-rule
          Arn: !GetAtt MomentoApiTopicsPost.Arn
          RoleArn: !GetAtt ApiDestinationsTargetRole.Arn
          InputTransformer:
            InputPathsMap:
              message: $.detail.success
            InputTemplate: '"<message>"'
          HttpParameters:
            PathParameterValues:
              - $.detail.cacheName
              - $.detail.topicName

Outputs:
  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref BlogUserPool
    Export:
      Name: !Sub "${AWS::StackName}-UserPoolId"

  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref BlogUserPoolClient
    Export:
      Name: !Sub "${AWS::StackName}-UserPoolClientId"

  ContentTableName:
    Description: DynamoDB Content Table Name
    Value: !Ref ContentTable
    Export:
      Name: !Sub "${AWS::StackName}-ContentTableName"

  BlogApiAuthorizerArn:
    Description: Blog API Lambda Authorizer ARN
    Value: !GetAtt BlogApiAuthorizer.Arn
    Export:
      Name: !Sub "${AWS::StackName}-BlogApiAuthorizerArn"

  BlogApiUrl:
    Description: Blog API Gateway URL
    Value: !Sub "https://${BlogApi}.execute-api.${AWS::Region}.amazonaws.com/api"
    Export:
      Name: !Sub "${AWS::StackName}-BlogApiUrl"
